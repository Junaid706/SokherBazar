{% extends "base.html" %}
{% load static %}
{% load custom_tags %}

{# Put CSS/JS includes in the correct head block used by base.html #}
{% block extra_css %}
<!-- Tailwind CSS (Play CDN) -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          primary: '#D35400',
          secondary: '#27AE60',
          accent: '#E67E22',
          dark: '#2C3E50'
        },
        boxShadow: {
          card: '0 8px 20px rgba(0,0,0,0.10)'
        }
      }
    }
  }
</script>

<!-- Font Awesome (icons) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
{% endblock %}

{% block content %}
<section class="py-10 bg-white">
  <div class="container w-full mx-auto px-4 sm:px-6 ">

    <!-- Header / Filters -->
<form method="get" class="flex flex-col md:flex-row md:items-center md:justify-between gap-6 mb-10 bg-white p-5 rounded-xl shadow-sm border border-gray-100">
  <!-- Title -->
  <h2 class="text-3xl font-semibold text-dark tracking-tight">
    All Handmade Products
  </h2>

  <!-- Filter Controls -->
  <div class="flex flex-wrap items-center gap-3 md:gap-4">
    <!-- Search -->
    <div class="relative">
      <i class="fa-solid fa-magnifying-glass absolute left-4 top-3 text-gray-400"></i>
      <input
        type="text"
        name="q"
        value="{{ request.GET.q }}"
        placeholder="Search products..."
        class="w-full sm:w-72 h-11 pl-11 pr-4 rounded-lg border border-gray-200 text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition"
      />
    </div>

    <!-- Category -->
    <div class="relative">
      <select
        name="category"
        class="h-11 pl-4 pr-10 rounded-lg border border-gray-200 bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-primary transition appearance-none"
      >
        <option value="">All Categories</option>
        {% for cat in categories %}
          <option value="{{ cat.id }}" {% if request.GET.category|stringformat:"s" == cat.id|stringformat:"s" %}selected{% endif %}>
            {{ cat.name }}
          </option>
        {% endfor %}
      </select>
      <i class="fa-solid fa-chevron-down absolute right-3 top-4 text-gray-400 text-sm pointer-events-none"></i>
    </div>

    <!-- Sort -->
    <div class="relative">
      <select
        name="sort"
        class="h-11 pl-4 pr-10 rounded-lg border border-gray-200 bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-primary transition appearance-none"
      >
        <option value="">Sort by: Featured</option>
        <option value="price_asc"  {% if request.GET.sort == 'price_asc' %}selected{% endif %}>Price: Low to High</option>
        <option value="price_desc" {% if request.GET.sort == 'price_desc' %}selected{% endif %}>Price: High to Low</option>
        <option value="newest"     {% if request.GET.sort == 'newest' %}selected{% endif %}>Newest</option>
        <option value="best_rated" {% if request.GET.sort == 'best_rated' %}selected{% endif %}>Best Rated</option>
      </select>
      <i class="fa-solid fa-chevron-down absolute right-3 top-4 text-gray-400 text-sm pointer-events-none"></i>
    </div>

    <!-- Button -->
    <button
      type="submit"
      class="h-11 px-8 rounded-full bg-primary text-white font-semibold shadow-sm hover:bg-orange-600 hover:shadow-md transition-all duration-200"
    >
      Apply
    </button>
  </div>
</form>


    <!-- Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-6">
      {% for product in products %}
      <div class="bg-white rounded-2xl overflow-hidden shadow-card hover:-translate-y-0.5 transition flex flex-col">
        <!-- Image -->
        <div class="relative h-56 bg-gray-100">
          {% if product.image %}
            <img src="{{ product.image.url }}" alt="{{ product.name }}" class="w-full h-full object-cover">
          {% else %}
            <img src="{% static 'images/default-product.jpg' %}" alt="{{ product.name }}" class="w-full h-full object-cover">
          {% endif %}

          <!-- Wishlist -->
          {% if product.id in user_wishlist_ids %}
            <a href="{% url 'remove_from_wishlist' product.id %}"
               class="absolute top-3 right-3 w-10 h-10 rounded-full bg-primary text-white grid place-items-center shadow hover:scale-105 transition"
               title="Remove from wishlist">
              <i class="fas fa-heart"></i>
            </a>
          {% else %}
            <a href="{% url 'add_to_wishlist' product.id %}"
               class="absolute top-3 right-3 w-10 h-10 rounded-full bg-white/90 text-primary border border-gray-200 grid place-items-center hover:bg-primary hover:text-white transition"
               title="Add to wishlist">
              <i class="far fa-heart"></i>
            </a>
          {% endif %}
        </div>

        <!-- Content -->
        <div class="p-4 flex-1 flex flex-col">
          <div class="text-secondary text-xs font-semibold mb-1">
            {{ product.category.name|default:"Uncategorized" }}
          </div>

          <h3 class="text-gray-900 font-semibold leading-snug line-clamp-2">
            {{ product.name }}
          </h3>

          <div class="text-sm text-gray-500 mt-1">
            By: {{ product.artisan.shop_name }}
          </div>

          <!-- Rating -->
          <div class="flex items-center gap-1 mt-2 text-yellow-400">
            {% for _ in product.star_list.full %}<i class="fa-solid fa-star"></i>{% endfor %}
            {% for _ in product.star_list.half %}<i class="fa-solid fa-star-half-stroke"></i>{% endfor %}
            {% for _ in product.star_list.empty %}<i class="fa-regular fa-star"></i>{% endfor %}
            <span class="text-gray-500 text-xs ml-1">({{ product.rating|default:"0" }})</span>
          </div>

          <!-- Price + Add -->
          <div class="mt-auto flex items-center justify-between pt-3">
            <div class="flex items-center gap-2">
              <span class="text-primary font-bold text-lg">৳ {{ product.discount_price|default:product.price }}</span>
              {% if product.discount_price %}
                <span class="text-gray-400 line-through text-sm">৳ {{ product.price }}</span>
              {% endif %}
            </div>

            <form action="{% url 'add_to_cart' product.id %}" method="POST">
              {% csrf_token %}
              <button type="submit"
                      class="w-10 h-10 rounded-full bg-primary text-white grid place-items-center hover:bg-orange-600 transition"
                      title="Add to Cart">
                <i class="fa-solid fa-cart-shopping"></i>
              </button>
            </form>
          </div>
        </div>
      </div>
      {% empty %}
        <p class="col-span-full text-center text-gray-500 text-lg">No products found.</p>
      {% endfor %}
    </div>

    <!-- Pagination -->
    {% if products.paginator.num_pages > 1 %}
    <div class="mt-10 flex justify-center">
      <nav class="inline-flex items-center gap-1" aria-label="Pagination">
        {% if products.has_previous %}
          <a href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}{% if request.GET.category %}category={{ request.GET.category }}&{% endif %}{% if request.GET.sort %}sort={{ request.GET.sort }}&{% endif %}page={{ products.previous_page_number }}"
             class="px-3 h-10 inline-flex items-center rounded-lg border border-gray-200 bg-white hover:bg-gray-50">Prev</a>
        {% else %}
          <span class="px-3 h-10 inline-flex items-center rounded-lg border border-gray-100 bg-gray-50 text-gray-400 cursor-not-allowed">Prev</span>
        {% endif %}

        {% for num in products.paginator.page_range %}
          {% if num == products.number %}
            <span class="px-3 h-10 inline-flex items-center rounded-lg bg-primary text-white">{{ num }}</span>
          {% elif num > products.number|add:'-3' and num < products.number|add:'3' %}
            <a href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}{% if request.GET.category %}category={{ request.GET.category }}&{% endif %}{% if request.GET.sort %}sort={{ request.GET.sort }}&{% endif %}page={{ num }}"
               class="px-3 h-10 inline-flex items-center rounded-lg border border-gray-200 bg-white hover:bg-gray-50">{{ num }}</a>
          {% endif %}
        {% endfor %}

        {% if products.has_next %}
          <a href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}{% if request.GET.category %}category={{ request.GET.category }}&{% endif %}{% if request.GET.sort %}sort={{ request.GET.sort }}&{% endif %}page={{ products.next_page_number }}"
             class="px-3 h-10 inline-flex items-center rounded-lg border border-gray-200 bg-white hover:bg-gray-50">Next</a>
        {% else %}
          <span class="px-3 h-10 inline-flex items-center rounded-lg border border-gray-100 bg-gray-50 text-gray-400 cursor-not-allowed">Next</span>
        {% endif %}
      </nav>
    </div>
    {% endif %}

  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
  // Optional client-side wishlist toggle effect (visual only; server state is updated by your GET links)
  document.querySelectorAll('a[title*="wishlist"]').forEach(function(btn){
    btn.addEventListener('click', function(){
      const icon = this.querySelector('i');
      if(!icon) return;
      icon.classList.toggle('fa-regular');
      icon.classList.toggle('fa-solid');
    });
  });
</script>
{% endblock %}
