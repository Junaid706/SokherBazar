{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<meta name="description" content="{{ product.meta_description|default:product.description|truncatechars:155 }}">
<link rel="canonical" href="{{ request.build_absolute_uri }}">

<!-- Open Graph -->
<meta property="og:type" content="product">
<meta property="og:title" content="{{ product.name }}">
<meta property="og:description" content="{{ product.meta_description|default:product.description|truncatechars:155 }}">
<meta property="og:url" content="{{ request.build_absolute_uri }}">
<meta property="og:image" content="{% if product.image %}{{ product.image.url }}{% else %}{% static 'images/default-product.jpg' %}{% endif %}">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ product.name }}">
<meta name="twitter:description" content="{{ product.meta_description|default:product.description|truncatechars:155 }}">
<meta name="twitter:image" content="{% if product.image %}{{ product.image.url }}{% else %}{% static 'images/default-product.jpg' %}{% endif %}">

<!-- Tailwind CSS (Play CDN) -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    theme: {
      extend: { colors: { primary:'#D35400', secondary:'#27AE60', accent:'#E67E22', dark:'#2C3E50' } }
    }
  }
</script>

<!-- Font Awesome (icons) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="bg-white text-gray-800">
  <div class=" mx-auto px-4 sm:px-6 lg:px-[200px]">

    <!-- Breadcrumbs -->
    <nav class="text-sm text-gray-500 py-4" aria-label="Breadcrumb">
      <ol class="flex items-center gap-2">
        <li><a href="{% url 'home' %}" class="hover:text-gray-700">Home</a></li>
        <li class="text-gray-400">/</li>
        <li><a href="{% url 'product_list' %}" class="hover:text-gray-700">Shop</a></li>
        <li class="text-gray-400">/</li>
        <li class="text-gray-700" aria-current="page">{{ product.name }}</li>
      </ol>
    </nav>

    <!-- Product -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-10 py-6 items-start">
      <!-- Media -->
      <div class="relative bg-orange-50 rounded-2xl overflow-hidden shadow">
        {% if product.image %}
          <img src="{{ product.image.url }}" alt="{{ product.name }}" class="w-full h-[480px] object-cover">
        {% else %}
          <img src="{% static 'images/default-product.jpg' %}" alt="{{ product.name }}" class="w-full h-[480px] object-cover">
        {% endif %}

        <button type="button"
                class="absolute top-4 right-4 w-12 h-12 rounded-full bg-white/90 text-primary border border-gray-200 grid place-items-center hover:bg-primary hover:text-white transition"
                aria-label="Add to wishlist">
          <i class="fa-regular fa-heart text-lg"></i>
        </button>
      </div>

      <!-- Info -->
      <div class="space-y-5">
        <div class="text-secondary text-sm font-medium">
          {% if product.category %}{{ product.category.name }}{% endif %}
        </div>

        <h1 class="text-3xl md:text-4xl font-semibold text-gray-900">{{ product.name }}</h1>

        <div class="flex flex-wrap items-center gap-4 text-sm text-gray-600">
          <span>By <strong>{{ product.artisan.shop_name }}</strong></span>
          <span class="flex items-center gap-1" aria-label="Rating {{ product.rating|default:'0' }} out of 5">
            {% for _ in product.star_list.full %}<i class="fa-solid fa-star text-yellow-400"></i>{% endfor %}
            {% for _ in product.star_list.half %}<i class="fa-solid fa-star-half-stroke text-yellow-400"></i>{% endfor %}
            {% for _ in product.star_list.empty %}<i class="fa-regular fa-star text-yellow-400"></i>{% endfor %}
            <span class="ml-1 text-gray-500">({{ product.rating|default:"0" }})</span>
          </span>
          <span class="{% if product.in_stock %}text-secondary{% else %}text-red-600{% endif %}">
            {% if product.in_stock %}In stock{% else %}Out of stock{% endif %}
          </span>
        </div>

        <!-- Price row -->
        <div class="flex flex-wrap items-center gap-3">
          <span class="text-2xl md:text-3xl font-bold text-primary">
            ৳ {{ product.discount_price|default:product.price }}
          </span>

          {% if product.discount_price %}
            <span class="text-gray-400 line-through">৳ {{ product.price }}</span>
          {% endif %}

          {% if savings %}
            <span class="inline-flex items-center gap-2 text-sm px-3 py-1 rounded-full bg-orange-100 text-orange-700">
              <i class="fa-solid fa-tag"></i>
              Save ৳ {{ savings|floatformat:2 }}{% if discount_percent %} ({{ discount_percent }}%){% endif %}
            </span>
          {% endif %}
        </div>

        <!-- Description -->
        <div class="bg-white border border-gray-100 rounded-xl p-4">
          <p class="text-gray-700 leading-relaxed">{{ product.description|linebreaksbr }}</p>
        </div>

        <!-- Purchase -->
        <form action="{% url 'add_to_cart' product.id %}" method="POST" class="flex flex-wrap items-center gap-3">
          {% csrf_token %}
          <div class="flex items-center border border-gray-200 rounded-full overflow-hidden">
            <button type="button" id="qtyMinus" class="w-10 h-10 grid place-items-center hover:bg-gray-50">
              <i class="fa-solid fa-minus text-gray-700"></i>
            </button>
            <input type="number" id="qtyInput" name="quantity" value="1" min="1" step="1"
                   class="w-14 h-10 text-center outline-none">
            <button type="button" id="qtyPlus" class="w-10 h-10 grid place-items-center hover:bg-gray-50">
              <i class="fa-solid fa-plus text-gray-700"></i>
            </button>
          </div>

          <button type="submit"
                  class="inline-flex items-center gap-2 px-6 h-11 rounded-full bg-primary text-white font-semibold hover:bg-orange-600 transition">
            <i class="fa-solid fa-cart-shopping"></i>
            Add to Cart
          </button>

          <a href="{% url 'product_list' %}"
             class="inline-flex items-center gap-2 px-6 h-11 rounded-full border-2 border-primary text-primary font-semibold hover:bg-primary hover:text-white transition">
            Back to Shop
          </a>
        </form>

        <!-- Share -->
        <div class="flex items-center gap-2 pt-1">
          <span class="text-sm text-gray-600">Share</span>
          {% with share_url=request.build_absolute_uri share_text=product.name %}
            <a class="w-9 h-9 grid place-items-center rounded-full border border-gray-200 hover:bg-gray-50"
               href="https://www.facebook.com/sharer/sharer.php?u={{ share_url|urlencode }}" target="_blank" rel="noopener" aria-label="Share on Facebook">
              <i class="fa-brands fa-facebook-f"></i>
            </a>
            <a class="w-9 h-9 grid place-items-center rounded-full border border-gray-200 hover:bg-gray-50"
               href="https://twitter.com/intent/tweet?url={{ share_url|urlencode }}&text={{ share_text|urlencode }}" target="_blank" rel="noopener" aria-label="Share on X">
              <i class="fa-brands fa-x-twitter"></i>
            </a>
            <a class="w-9 h-9 grid place-items-center rounded-full border border-gray-200 hover:bg-gray-50"
               href="https://www.linkedin.com/sharing/share-offsite/?url={{ share_url|urlencode }}" target="_blank" rel="noopener" aria-label="Share on LinkedIn">
              <i class="fa-brands fa-linkedin-in"></i>
            </a>
            <a class="w-9 h-9 grid place-items-center rounded-full border border-gray-200 hover:bg-gray-50"
               href="https://wa.me/?text={{ share_text|urlencode }}%20{{ share_url|urlencode }}" target="_blank" rel="noopener" aria-label="Share on WhatsApp">
              <i class="fa-brands fa-whatsapp"></i>
            </a>
          {% endwith %}
        </div>
      </div>
    </section>

    {% if related_products %}
    <!-- Related -->
    <section class="bg-orange-50 rounded-2xl p-6 md:p-8 my-10">
      <h2 class="text-xl md:text-2xl font-semibold text-dark text-center mb-5">You May Also Like</h2>
      <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-5">
        {% for item in related_products %}
          <a href="{% url 'product_detail' item.id %}" class="block bg-white rounded-xl overflow-hidden shadow hover:-translate-y-0.5 transition">
            <img
              src="{% if item.image %}{{ item.image.url }}{% else %}{% static 'images/default-product.jpg' %}{% endif %}"
              alt="{{ item.name }}"
              class="w-full h-44 object-cover">
            <div class="p-4">
              <p class="font-medium text-gray-900 truncate">{{ item.name }}</p>
              <p class="text-primary font-semibold mt-1">৳ {{ item.discount_price|default:item.price }}</p>
            </div>
          </a>
        {% endfor %}
      </div>
    </section>
    {% endif %}

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  (function(){
    const minus = document.getElementById('qtyMinus');
    const plus  = document.getElementById('qtyPlus');
    const input = document.getElementById('qtyInput');

    const clamp = () => {
      const v = parseInt(input.value || '1', 10);
      input.value = isNaN(v) || v < 1 ? 1 : v;
    };
    minus && minus.addEventListener('click', ()=>{ input.value = Math.max(1, parseInt(input.value||'1',10) - 1); });
    plus  && plus.addEventListener('click', ()=>{ input.value = Math.max(1, parseInt(input.value||'1',10) + 1); });
    input && input.addEventListener('change', clamp);
  })();
</script>
{% endblock %}
